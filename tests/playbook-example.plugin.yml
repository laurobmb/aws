---
- name: AWS Account Management
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    project: "AppProject"
    email: "lauroinf5@hotmail.com"
    destination_ou_id: "ou-8rpp-cm4auzsq"

    role_name_custom: "OrganizationAccountAccessRole"

    tags_da_conta:
      - Key: Project
        Value: "{{ project }}"
      - Key: Environment
        Value: "development"
      - Key: AutomationTool
        Value: "Ansible"

  tasks:
    - name: Criar nova conta AWS com Role e Tags
      laurobmb.aws.organization_account:
        action: create_account
        email: "{{ email }}"
        name: "{{ project }}"
        admin_role_name: "{{ role_name_custom }}"
        tags: "{{ tags_da_conta }}"
      register: create_account_result

    - name: Mostrar o resultado completo da criação
      ansible.builtin.debug:
        var: create_account_result

    - name: Mover a conta recém-criada para a OU de destino
      laurobmb.aws.organization_account:
        action: move_account
        id: "{{ create_account_result.status.AccountId }}"
        ou_id: "{{ destination_ou_id }}"
      when: create_account_result.changed
